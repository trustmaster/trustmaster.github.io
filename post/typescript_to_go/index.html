<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="A system brought to life">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://blog.kodigy.com//img/post-bg.jpg">
    <meta property="twitter:image" content="https://blog.kodigy.com//img/post-bg.jpg" />
    

    
    <meta name="title" content="TypeScript: JavaScript way to Go" />
    <meta property="og:title" content="TypeScript: JavaScript way to Go" />
    <meta property="twitter:title" content="TypeScript: JavaScript way to Go" />
    

    
    <meta name="description" content="Taking the best of the 2 worlds: rapidness of development with dynamic languages and reliability of static languages with TypeScript. Contains some Go inspiration">
    <meta property="og:description" content="Taking the best of the 2 worlds: rapidness of development with dynamic languages and reliability of static languages with TypeScript. Contains some Go inspiration" />
    <meta property="twitter:description" content="Taking the best of the 2 worlds: rapidness of development with dynamic languages and reliability of static languages with TypeScript. Contains some Go inspiration" />
    

    
    
    <meta property="twitter:card" content="Taking the best of the 2 worlds: rapidness of development with dynamic languages and reliability of static languages with TypeScript. Contains some Go inspiration" />
    
    
    

    <meta name="keyword" content="">
    <link rel="shortcut icon" href="https://blog.kodigy.com/img/favicon.ico">

    <title>TypeScript: JavaScript way to Go-</title>

    <link rel="canonical" href="https://blog.kodigy.com/post/typescript_to_go/">

    <link rel="stylesheet" href="https://blog.kodigy.com/css/iDisqus.min.css" />

    
    <link rel="stylesheet" href="https://blog.kodigy.com/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="https://blog.kodigy.com/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="https://blog.kodigy.com/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">

    
    <link rel="stylesheet" href="https://blog.kodigy.com/css/custom.css">

    
    
    <script src="https://blog.kodigy.com/js/jquery.min.js"></script>

    
    <script src="https://blog.kodigy.com/js/bootstrap.min.js"></script>

    
    <script src="https://blog.kodigy.com/js/hux-blog.min.js"></script>

    
    

</head>

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://blog.kodigy.com/">A system brought to life</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    
                    
                    
                    <li>
                        <a href="https://blog.kodigy.com/categories/development">development</a>
                    </li>
                    
                    <li>
                        <a href="https://blog.kodigy.com/categories/flow-based-programming">flow-based-programming</a>
                    </li>
                    
                    <li>
                        <a href="https://blog.kodigy.com/categories/productivity">productivity</a>
                    </li>
                    
                    

                    
                    <li><a href="https://blog.kodigy.com/about/author/">About</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e) {
        if ($navbar.className.indexOf('in') > 0) {
            
            $navbar.className = " ";
            
            setTimeout(function () {
                
                if ($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            }, 400)
        } else {
            
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>



<style type="text/css">
    header.intro-header {
        background-image: url('/img/post-bg.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="https://blog.kodigy.com/%20/tags/development" title="development">
                            development
                        </a>
                        
                    </div>
                    <h1>TypeScript: JavaScript way to Go</h1>
                    <h2 class="subheading">Taking the best of the 2 worlds: rapidness of development with dynamic languages and reliability of static languages with TypeScript. Contains some Go inspiration</h2>
                    <span class="meta">
                        
                        A 10 minute read.
                        
                        Published on
                        July 26, 2017
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <div class="table-of-contents">
                    <header>
                        <h2>Contents</h2>
                    </header>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#less-is-more">Less is more</a>
      <ul>
        <li><a href="#the-must-haves">The must haves</a></li>
        <li><a href="#minimalistic-type-annotations">Minimalistic type annotations</a></li>
        <li><a href="#do-you-really-need-a-generic-here">Do you really need a generic here?</a></li>
      </ul>
    </li>
    <li><a href="#using-interfaces-to-make-code-more-generic-and-testable">Using interfaces to make code more generic and testable</a>
      <ul>
        <li><a href="#interface-for-a-domain-model">Interface for a domain model</a></li>
        <li><a href="#interface-for-a-dependency">Interface for a dependency</a></li>
        <li><a href="#using-the-interfaces">Using the interfaces</a></li>
        <li><a href="#mocking-a-service">Mocking a service</a></li>
        <li><a href="#testing">Testing</a></li>
      </ul>
    </li>
    <li><a href="#bottom-line">Bottom line</a></li>
  </ul>
</nav>
                </div>
                
                <p>My journey at <a href="https://thegrid.io">The Grid</a> was over and I had 3 months before the start of a new contract, so I took an opportunity to fill a position of an interim CTO at <a href="https://dater.com">Dater.com</a>, a new dating app that is going to change the industry by moving from &ldquo;post &amp; search&rdquo; approach to online &amp; offline game-alike activity.</p>
<p>The main challenge was setting higher standards of development culture within the team and facilitating the development cycle. But speaking of the technical side of things, the project is rather interesting too: TypeScript / Angular 4 / Ionic / Firebase / Google Cloud Services.</p>
<p>In this article I&rsquo;d like to share a couple of patterns that I found myself useful in this project and share some general thoughts on TypeScript.</p>
<h2 id="less-is-more">Less is more</h2>
<p>One of my colleagues said that TypeScript is a rather successful attempt to turn JavaScript into C#. I have to admit that such a statement has some reason behind it. With TypeScript you have full power of Inheritance, Access Modifiers, Mixins, Generics, Decorators, Interfaces, Union types, and what not.</p>
<p>It is very easy to find yourself spending a lot of time trying to choose a proper language construct for the problem, or just blindly mimicking the .NET habits in a project that is actually driven by a JavaScript engine.</p>
<p>Instead, how about applying the &quot;less is more&quot; principle to use only the essential features and focus on code rather than language? So that we could benefit from the dynamic nature of JavaScript and reliability of static languages.</p>
<h3 id="the-must-haves">The must haves</h3>
<p>So, let&rsquo;s pick the very essential features of TypeScript first.</p>
<p>Here is the Top 5 features that I like in TypeScript:</p>
<ol>
<li><em>ES2015+</em> - it&rsquo;s nice to keep writing just modern JavaScript in first place. Bonus: you don&rsquo;t have to deal with Babel.</li>
<li><em>Type Annotations</em> - this actually brings 3 benefits:</li>
</ol>
<ul>
<li>static analysis makes the code more reliable;</li>
<li>the code is more self-documenting;</li>
<li>you get nice Code Intelligence features not only in Visual Studio but also in editors like SublimeText and Vim. For example, here is how it looks in SublimeText:</li>
</ul>
<ol start="3">
<li><em>Interfaces</em> - they can help writing more generic and testable code, see below.</li>
<li><em>TSLint</em> - I actually use a combination of <a href="https://www.npmjs.com/package/tslint-config-airbnb">TSLint + ESLint + AirBnB JavaScript Code Style Guide</a> to enforce more good practices in the code than a TypeScript compiler provides out of the box.</li>
<li>OK, it&rsquo;s hard to pick the last one. Especially because things like <code>async/await</code> are already included in #1.</li>
</ol>
<p>
  <img src="https://blog.kodigy.com/img/post/typescript_sublime_autocomplete_2.png" alt="TypeScript autocomplete in ST3">

</p>
<p><em>Fig. 1: TypeScript autocomplete and linter example in SublimeText3</em></p>
<p>Really, all the features in the above list are cool, so if TypeScript is an acceptable part of your toolbox, you should try them to make work with JavaScript projects more enjoyable. Just fire up your favorite editor and try them!</p>
<p><em>Note: I suspect that this is partially or fully applicable to <a href="https://flowlang.org">Flowtype</a> as well, but I won&rsquo;t claim it this time because I need to do some practical Flow first</em>.</p>
<h3 id="minimalistic-type-annotations">Minimalistic type annotations</h3>
<p>A common thread that many TypeScripters share is this: <em>define and annotate everything</em>. Some say it helps them feel more confident, some use this approach just for sake of IntelliSence. But for those who care of the balance between quality of code and development pace, there a simple alternative: <em>use the power of automatic type inference</em>. The most common places where type annotations come handy are:</p>
<ul>
<li>interface definitions;</li>
<li>function arguments;</li>
<li>class properties.</li>
</ul>
<p>There the annotations hit two birds with one stone: make the code more self-documenting and give the compiler enough information for type inference. Inside the methods, if decomposed properly, the compiler is capable to infer a type for most of the variables. If you think this is too dynamic and unsafe, have a look at how Go compiler does a similar thing while keeping the code strictly typed.</p>
<h3 id="do-you-really-need-a-generic-here">Do you really need a generic here?</h3>
<p>Another common overengineering practice with TypeScript is using Generics to turn every possible type into a container and every possible function into a template function. This is a waste of time not only for those who write such code but also for those innocent souls who have to read and maintain it onwards.</p>
<p>Here are a couple of questions that need to be answered before using a generic:</p>
<ul>
<li>Is it really a generic or something that complies with a certain interface? In latter case, use an <code>interface</code> instead.</li>
<li>Is it really a generic or just <code>any</code>? If there&rsquo;s no pattern in how the data is used or if it&rsquo;s just an <code>Object</code>, then it&rsquo;s likely to be <code>any</code>.</li>
</ul>
<p>OK, time to put the Occam&rsquo;s razor aside and dive deeper into one of the fundamental parts of TypeScript: interfaces.</p>
<h2 id="using-interfaces-to-make-code-more-generic-and-testable">Using interfaces to make code more generic and testable</h2>
<p>In Go, interfaces are often used to implement polymorphic functions and Dependency Injection pattern. We can do a similar thing in TypeScript.</p>
<p>Let&rsquo;s implement a function that persists a <code>User</code> record in <a href="https://firebase.google.com/">FireBase</a>.</p>
<h3 id="interface-for-a-domain-model">Interface for a domain model</h3>
<p>First, let&rsquo;s agree that a <code>User</code> is any object that conforms with the following interface:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">User</span> {
  <span style="color:#a6e22e">key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>;
  <span style="color:#a6e22e">email</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>;
  <span style="color:#a6e22e">fullName</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">string</span>;
  <span style="color:#a6e22e">birthday</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">number</span>;
}
</code></pre></div><p>A downside of interfaces in TypeScript is that they only exist at compile time. Meanwhile it makes whole lot of sense to check the data against interfaces at run time. A proposed method to solve this is to provide a type guard per interface:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isUser</span>(<span style="color:#a6e22e">object</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">object</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">User</span> {
  <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;key&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">object</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#e6db74">&#39;email&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">object</span>);
}
</code></pre></div><p>Type guards are used just as other functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isUser</span>(<span style="color:#a6e22e">user</span>)) {
  <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Invalid user object&#39;</span>);
}
</code></pre></div><p>Writing a type guard per interface is not at all convenient, so a better solution remains an open question for now.</p>
<h3 id="interface-for-a-dependency">Interface for a dependency</h3>
<p>Interfaces can be used effectively to abstract the way dependencies are used from their implementation.</p>
<p>For instance, here are a couple of interfaces kindly provided by the <code>firebase</code> library itself:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// Example extracts from firebase.d.ts, (c) Google
</span><span style="color:#75715e"></span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Database</span> {
  <span style="color:#a6e22e">app</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">App</span>;
  <span style="color:#a6e22e">goOffline</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>;
  <span style="color:#a6e22e">goOnline</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>;
  <span style="color:#a6e22e">ref</span>(<span style="color:#a6e22e">path</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Reference</span>;
  <span style="color:#a6e22e">refFromURL</span>(<span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Reference</span>;
}

<span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Reference</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Query</span> {
  <span style="color:#a6e22e">child</span>(<span style="color:#a6e22e">path</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Reference</span>;
  <span style="color:#a6e22e">key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span><span style="color:#f92672">|</span><span style="color:#66d9ef">null</span>;
  <span style="color:#75715e">// ... (snap) ...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">value</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">onComplete</span><span style="color:#f92672">?:</span> (<span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> Error<span style="color:#f92672">|</span><span style="color:#66d9ef">null</span> ) =&gt; <span style="color:#a6e22e">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">ThenableReference</span>;
  <span style="color:#a6e22e">remove</span>(<span style="color:#a6e22e">onComplete</span><span style="color:#f92672">?:</span> (<span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> Error <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>) =&gt; <span style="color:#a6e22e">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
  <span style="color:#a6e22e">root</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Reference</span>;
  <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">onComplete</span><span style="color:#f92672">?:</span> (<span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> Error<span style="color:#f92672">|</span><span style="color:#66d9ef">null</span>) =&gt; <span style="color:#a6e22e">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.Promise <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
  <span style="color:#75715e">// ... (snap) ...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">values</span><span style="color:#f92672">:</span> Object, <span style="color:#a6e22e">onComplete</span><span style="color:#f92672">?:</span> (<span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> Error<span style="color:#f92672">|</span><span style="color:#66d9ef">null</span>) =&gt; <span style="color:#a6e22e">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.Promise <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
}
</code></pre></div><p>We can just import them in our project:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">database</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;firebase&#39;</span>;

<span style="color:#75715e">// Now we can type database.Database or database.Reference and get some nice code hints
</span></code></pre></div><p>Firebase is a good example of an API that provides the reusable TypeScript interfaces out of the box (I could brag that <code>firebase</code> interfaces are not compatible with <code>firebase-admin</code> interfaces, but that&rsquo;s a different issue). Another option is obtaining <code>.d.ts</code> files from the <a href="http://definitelytyped.org/">DefinitelyTyped</a> project. Though, not all services and libraries come with definitions provided, so if your project relies on some 3rd party API that you want to be interchangeable and testable, you should consider implementing a minimal interface for it yourself. This is also the case if the definitions exist but are not up to date or contain tightly coupled code that depends on a certain way of use. So, I have to cry this out loud:</p>
<p><em>Dear TypeScript library maintainers, please consider using <code>interface</code> instead of <code>class</code> to describe your API. In many cases it&rsquo;s just a matter of writing a few lines of code more, or even just replacing <code>class</code> with <code>interface</code>, but it makes coupling of client code more loose and your consumers won&rsquo;t have to maintain interfaces for your API themselves.</em></p>
<h3 id="using-the-interfaces">Using the interfaces</h3>
<p>Consuming interfaces is almost identical to using &ldquo;normal&rdquo; types. Here is our <code>addUser</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addUser</span>(<span style="color:#a6e22e">db</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Database</span>, <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">User</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">User</span><span style="color:#f92672">&gt;</span> {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">email</span>) {
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;User email is required&#39;</span>);
  }
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">savedUser</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">user</span>;
  <span style="color:#a6e22e">savedUser</span>.<span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">ref</span>(<span style="color:#e6db74">&#39;Users&#39;</span>).<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">user</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">ref</span>(<span style="color:#e6db74">&#39;/Users&#39;</span>).<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">savedUser</span>);
}
</code></pre></div><p>This is how we could call it passing real objects:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">firebase</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;firebase&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">addUser</span>, <span style="color:#a6e22e">User</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./lib/user&#39;</span>;

<span style="color:#75715e">// Somewhere down the line
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">userInput</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">User</span><span style="color:#f92672">&gt;</span>{
  <span style="color:#a6e22e">email</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">email</span>,
  <span style="color:#a6e22e">fullName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">fullName</span>,
  <span style="color:#a6e22e">birthday</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">birthday</span>,
};

<span style="color:#66d9ef">try</span> {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">addUser</span>(<span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>(), <span style="color:#a6e22e">userInput</span>);
  <span style="color:#a6e22e">sendResult</span>(<span style="color:#a6e22e">user</span>);
} <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
  <span style="color:#a6e22e">sendError</span>(<span style="color:#a6e22e">err</span>);
}
</code></pre></div><p>Dealing with <code>User</code> is really trivial here, all you need to notice is how we pass <code>firebase.database()</code> as a dependency service.</p>
<h4 id="alternative-ways-to-organize-containers">Alternative ways to organize containers</h4>
<p>Passing everything as the arguments of a function may be inconvenient. In many cases dependency containers are passed as class <code>constructor</code> arguments, so that the containers are reused through the state of <code>this</code>. Example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">database</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;firebase&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Bucket</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./lib/google-cloud-storage&#39;</span>; <span style="color:#75715e">// Custom service interface
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserStorage</span> {
  <span style="color:#a6e22e">constructor</span>(<span style="color:#66d9ef">private</span> <span style="color:#a6e22e">db</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">Database</span>, <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Bucket</span>) { }
  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addUser</span>(<span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">User</span>) {
    <span style="color:#75715e">// The implementation is very similar to a function written before
</span><span style="color:#75715e"></span>  }
}
</code></pre></div><p>In functional or dataflow programming dependencies are passed as function arguments or as combined objects (messages/IPs/etc.). In the latter case it makes sense to separate dependencies from actual input:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Deps</span> {
  <span style="color:#a6e22e">db</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">Database</span>,
  <span style="color:#a6e22e">bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Bucket</span>,
}

<span style="color:#75715e">// Factory function that returns an addUser implementation using the `deps`
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">makeAddUser</span>(<span style="color:#a6e22e">deps</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Deps</span>)<span style="color:#f92672">:</span> (<span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">User</span>) =&gt; Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">User</span><span style="color:#f92672">&gt;</span> {
  <span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">User</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">User</span><span style="color:#f92672">&gt;</span> =&gt; {
    <span style="color:#75715e">// Here we use `database` and `bucket` from `deps` to save `user`
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Let&#39;s write an example promise chain
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">findUserFiles</span>(<span style="color:#a6e22e">deps</span>, <span style="color:#a6e22e">user</span>)
      .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">files</span>) =&gt; <span style="color:#a6e22e">uploadFiles</span>(<span style="color:#a6e22e">deps</span>, <span style="color:#a6e22e">files</span>))
      .<span style="color:#a6e22e">then</span>(() =&gt; <span style="color:#a6e22e">saveUser</span>(<span style="color:#a6e22e">deps</span>, <span style="color:#a6e22e">user</span>));
  }
}

<span style="color:#75715e">// Example usage
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">addUser</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">makeAddUser</span>({ <span style="color:#a6e22e">db</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>(), <span style="color:#a6e22e">bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">gcsBucket</span> });
<span style="color:#a6e22e">addUser</span>(<span style="color:#a6e22e">userData</span>)
.<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">user</span>) =&gt; {
  <span style="color:#75715e">// Success
</span><span style="color:#75715e"></span>})
.<span style="color:#66d9ef">catch</span>((<span style="color:#a6e22e">err</span>) =&gt; {
  <span style="color:#75715e">// Error
</span><span style="color:#75715e"></span>});
</code></pre></div><p>It&rsquo;s a matter of specific application design choice how to wrap the concept. Underneath it remains the same.</p>
<h3 id="mocking-a-service">Mocking a service</h3>
<p>Now we get closer to what this is all about. Let&rsquo;s write a mock for local Firebase testing using the <a href="htts://npmjs.com/package/firebase-server">FirebaseServer</a> package.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">firebase</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;firebase&#39;</span>;
<span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">FirebaseServer</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;firebase-server&#39;</span>;

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FirebaseMock</span> {
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">app</span>;
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">server</span>;
  <span style="color:#a6e22e">constructor</span>(<span style="color:#66d9ef">private</span> <span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5151</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FirebaseServer</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">port</span>, <span style="color:#e6db74">&#39;test-app-local.firebaseio.com&#39;</span>);
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">initializeApp</span>({
      <span style="color:#a6e22e">apiKey</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;fake-key&#39;</span>,
      <span style="color:#a6e22e">databaseURL</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`ws://test-app-local.firebaseio.com:</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">port</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
    });
  }
  <span style="color:#a6e22e">database</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Database</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">app</span>);
  }
  <span style="color:#a6e22e">stop</span>(<span style="color:#a6e22e">callback</span>) {
    <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">app</span>().<span style="color:#66d9ef">delete</span>();
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">close</span>(<span style="color:#a6e22e">callback</span>);
  }
}
</code></pre></div><p>Mocking Firebase with <code>firebase-server</code> is as easy as that. In other cases you might actually need to implement some mocking methods that mimick the interface.</p>
<h3 id="testing">Testing</h3>
<p>This is bread and butter of Dependency Injection. Let&rsquo;s write a Mocha/Chai.js test for our function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">database</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;firebase&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">addUser</span>, <span style="color:#a6e22e">User</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./lib/user&#39;</span>;
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">FirebaseMock</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./mocks/firebase&#39;</span>;

<span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;addUser()&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">firebase</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">FirebaseMock</span>;
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">db</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">Database</span>;
  <span style="color:#a6e22e">before</span>((<span style="color:#a6e22e">done</span>) =&gt; {
    <span style="color:#a6e22e">firebase</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FirebaseMock</span>();
    <span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">database</span>();
    <span style="color:#a6e22e">done</span>();
  });
  <span style="color:#a6e22e">after</span>((<span style="color:#a6e22e">done</span>) =&gt; {
    <span style="color:#a6e22e">firebase</span>.<span style="color:#a6e22e">stop</span>(<span style="color:#a6e22e">done</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;adds a user&#39;</span>, <span style="color:#66d9ef">async</span> () =&gt; {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">User</span><span style="color:#f92672">&gt;</span>{
      <span style="color:#a6e22e">email</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;john@example.com&#39;</span>,
      <span style="color:#a6e22e">fullName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;John Appleseed&#39;</span>
    };
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">savedUser</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">addUser</span>(<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">user</span>);
    <span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">savedUser</span>.<span style="color:#a6e22e">key</span>).<span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">be</span>.<span style="color:#a6e22e">a</span>(<span style="color:#e6db74">&#39;string&#39;</span>);
    <span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">savedUser</span>.<span style="color:#a6e22e">email</span>).<span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">equal</span>(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">email</span>);
    <span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">savedUser</span>.<span style="color:#a6e22e">fullName</span>).<span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">equal</span>(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">fullName</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;discards non-user objects&#39;</span>, <span style="color:#66d9ef">async</span>() =&gt; {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">User</span><span style="color:#f92672">&gt;</span>{};
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">didThrow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
    <span style="color:#66d9ef">try</span> {
      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">addUser</span>(<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">user</span>);
    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
      <span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">e</span>).<span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">be</span>.<span style="color:#a6e22e">an</span>(<span style="color:#e6db74">&#39;error&#39;</span>);
      <span style="color:#a6e22e">didThrow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
    } <span style="color:#66d9ef">finally</span> {
      <span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">didThrow</span>).<span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">be</span>.<span style="color:#66d9ef">true</span>;
    }
  });
});
</code></pre></div><p>If we omit the testing boilerplate, there is nothing here that would be different from the normal consumer code, meanwhile a mock is being used. All we have to do is to pass the mock object to the code being tested instead of a real service.</p>
<h2 id="bottom-line">Bottom line</h2>
<p>There are many topics which I haven&rsquo;t covered in this article. For example, <em>Union types</em> which you can combine with <em>strict null checks</em> to make the use of <code>null</code> as a &ldquo;third state&rdquo; explicit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">type</span> <span style="color:#a6e22e">OrderRecord</span> <span style="color:#66d9ef">interface</span> {
  <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">number</span>;
  <span style="color:#a6e22e">user_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">number</span>;
  <span style="color:#a6e22e">comment</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span><span style="color:#f92672">|</span><span style="color:#66d9ef">null</span>;
}
</code></pre></div><p>Also <em>Union types</em> are useful for the <em>return value or error</em> pattern:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getItem</span>(<span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">number</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Item</span><span style="color:#f92672">|</span>Error {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">somethingWentWrong</span>()) {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Oops&#39;</span>);
  }
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">item</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">loadItemFromSomewhere</span>(<span style="color:#a6e22e">id</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">item</span>;
}
</code></pre></div><p>But the main thought is this: it&rsquo;s not about how many language features are used in your projects, it&rsquo;s about how the most essential onces can be applied to achieve your team&rsquo;s goals.</p>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="https://blog.kodigy.com/post/noflo_08_npm_shrinkwrap/" data-toggle="tooltip" data-placement="top"
                            title="Forcing a specific NoFlo version for all dependencies">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="https://blog.kodigy.com/post/solid_principles_in_short_poems/" data-toggle="tooltip" data-placement="top"
                            title="SOLID design principles in short poems">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="https://blog.kodigy.com/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        <a href="https://blog.kodigy.com/%20/tags/development" title="development">
                            development
                        </a>
                        
                        
                        
                        <a href="https://blog.kodigy.com/%20/tags/fbp" title="fbp">
                            fbp
                        </a>
                        
                        
                        
                        <a href="https://blog.kodigy.com/%20/tags/noflo" title="noflo">
                            noflo
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href='' rel="alternate"
                            type="application/rss+xml" title="A system brought to life">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    

                    
                    <li>
                        <a href="https://twitter.com/sibiroff">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    

                    

                    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/trustmaster">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/sibirov">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Vladimir Sibirov 2021
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a
                        href="https://zhaohuabing.com">Huabing</a>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if ($('#tag_cloud').length !== 0) {
        async("/js/jquery.tagcloud.js", function () {
            $.fn.tagcloud.defaults = {
                
                color: { start: '#bbbbee', end: '#0085a1' },
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>






<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-92537342-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>